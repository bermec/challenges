(function(){var e=function(e,t,n,r){var o=0,a=1,s={defaults:{"bind.open":"click","bind.close":"click","bind.action":"click","attribute.open":"data-modal","attribute.close":"data-modal-close","attribute.iframe":"data-modal-iframe","attribute.action":"data-modal-action","attribute.focus":"data-modal-focus","attribute.focus.index":1e4,"animate.modal.open":null,"animate.modal.close":null,"animate.modal.duration":250,"animate.overlay.open":null,"animate.overlay.close":null,"animate.overlay.duration":250,"overlay.show":!0,"overlay.class":"overlay","overlay.close":!0,"z.index":9999,"position.top":"50%","position.left":"50%",position:"fixed","iframe.autoclose":!0},$overlay:null,count:0,prevScroll:null,prevModal:null,getModal:function(t,n){var i=e(t).data("modal.me");return i&&i.constructor==l.prototype.constructor?n?i.customize(n):i:null},makeModal:function(t,n){var i=e(t),r=s.getModal(i);return r||(r=new l(i,n),i.data("modal.me",r)),r},setOverlayHeight:function(){e(window).height()<e(document).height()?s.$overlay.css({height:e(document).height()+"px"}):s.$overlay.css({height:"100%"})},observeKeyPress:function(e){(27==e.keyCode||27==e.DOM_VK_ESCAPE&&0===e.which)&&(this.emitter.trigger("action",!1,this),this.close())},actionTrigger:function(t){var n=e(t.currentTarget),i=n.attr(this.options["attribute.action"]);this.emitter.trigger("action",i,this)},open:function(){if("fixed"!=this.options.position&&(s.prevScroll={top:e(document).scrollTop(),left:e(document).scrollLeft()},window.scrollTo(0,0)),this.$iframe){var t=this.options["iframe.url"]||e(this.anchor).attr(this.options["attribute.iframe"]);this.$iframe.attr("src",t),this.$iframe.focus()}else{var r=this.$el.find("["+this.options["attribute.focus"]+"]").filter(":visible"),o=this.$el.find("a,input,select,textarea,button").filter(":visible");for(i=0;o.length>i;i++)o.eq(i).attr("tabindex",this.options["attribute.focus.index"]+1+i);r.size()>0?(r.eq(0).attr("tabindex",this.options["attribute.focus.index"]),r.eq(0).focus()):o.size()>0&&(o.eq(0).attr("tabindex",this.options["attribute.focus.index"]),o.eq(0).focus())}this.state=a,this.$el.on(this.options["bind.action"],"["+this.options["attribute.action"]+"]",n.bind(s.actionTrigger,this)),this.emitter.trigger("open")},close:function(){var e=this.$el.find("iframe");this.$el.off(".modal").hide(),this.options["iframe.autoclose"]&&e.size()&&e.attr({src:"about:blank"}),s.prevScroll&&(window.scrollTo(s.prevScroll.left,s.prevScroll.top),s.prevScroll=null),this.anchor=null,this.$parent.append(this.$el),this.state=o,this.emitter.trigger("close")}},l=function(n,i){this.$el=e(n),this.state=o,this.$parent=this.$el.parent(),this.customize(i),this.emitter=t.emitter(this)};l.prototype.customize=function(e){return this.options=n.extend({},r.parse(this.$el,s.defaults,"data-modal-"),e),this},l.prototype.open=function(){var t,i=this;return this.anchor&&(t=e(this.anchor).attr(this.options["attribute.iframe"])),this.options["iframe.url"]&&(t=this.options["iframe.url"]),t&&(this.$iframe=this.$el.find("iframe"),/^https?:\/\/|^\/|^\.\.\//.test(t)&&(this.$iframe.size()&&this.$iframe.attr("src")==t||(this.$iframe.attr("src","about:blank").remove(),this.$iframe=e("<iframe>").css({height:"100%",width:"100%"}).attr({scrolling:"no",frameborder:0}),this.$el.append(this.$iframe),this.state!=o&&this.$iframe.attr("src",t)))),this.state==o?(this.options["overlay.show"]&&(s.$overlay&&"none"!=s.$overlay.css("display")&&s.$overlay.hasClass(this.options["overlay.class"])?this.$overlay=s.$overlay:(s.$overlay&&s.$overlay.off(".modal").hide().remove(),this.$overlay=s.$overlay=e("<div>").addClass(this.options["overlay.class"]).hide(),this.$overlay.css({position:"fixed",width:"100%",top:0,left:0,right:0,bottom:0,zIndex:this.options["z.index"]++}),e("body").append(this.$overlay)),s.setOverlayHeight(),this.reposition(),this.options["animate.overlay.open"]?this.$overlay.animate(this.options["animate.overlay.open"],{duration:this.options["animate.overlay.duration"]}):this.$overlay.show(),s.count++,this.$overlay.data("modal",this)),this.emitter.trigger("opening"),("fixed"!=this.options.position||0===this.$el.closest("html").length)&&this.$el.appendTo("body"),this.reposition(),this.$el.show(),this.options["animate.modal.open"]?this.$el.animate(this.options["animate.modal.open"],{duration:this.options["animate.modal.duration"],complete:function(){s.open.call(i)}}):s.open.call(this),e(window).on("resize.modal",n.bind(s.setOverlayHeight,i)).on("resize.modal",n.bind(i.reposition,i)).on("scroll.modal",n.bind(i.reposition,i)),this.options["overlay.close"]&&(e(window).on("keyup.modal",n.bind(s.observeKeyPress,i)),this.$overlay.on(this.options["bind.close"]+".modal",function(){i.emitter.trigger("action",!1,i),i.close()})),this.options["attribute.close"]&&this.$el.on(this.options["bind.close"]+".modal","["+this.options["attribute.close"]+"]",function(t){var n=e(t.currentTarget);"disabled"!=n.attr("disabled")&&(void 0===n.attr(i.options["attribute.action"])&&i.emitter.trigger("action",!1,i),i.close())}),this):void 0},l.prototype.reposition=function(){var e=this.options["position.left"],t=this.options["position.top"];return e&&this.$el.css({position:this.options.position,left:e,marginLeft:/%/.test(e)?-1*(this.$el.outerWidth()/2):0,zIndex:this.options["z.index"]++}),t&&this.$el.css({position:this.options.position,top:t,marginTop:/%/.test(t)?-1*(this.$el.outerHeight()/2):0,zIndex:this.options["z.index"]++}),this},l.prototype.close=function(){var t=this;if(this.state==a)return this.$el.off(".modal"),e(window).off(".modal"),this.emitter.trigger("closing"),this.options["animate.modal.close"]?this.$el.animate(this.options["animate.modal.close"],{duration:this.options["animate.modal.duration"],complete:function(){s.close.call(t)}}):s.close.call(this),0===--s.count&&this.options["overlay.show"]&&this.$overlay&&(this.$overlay.off(".modal"),this.options["animate.overlay.close"]?this.$overlay.animate(this.options["animate.overlay.close"],{duration:this.options["animate.overlay.duration"],complete:function(){this.$overlay.hide().remove()}}):this.$overlay.hide().remove()),this};var c=function(){return s.getModal.apply(null,arguments)||s.makeModal.apply(this,arguments)};return c.start=function(t,i){var o=e(t),a=n.extend({},s.defaults,i);o.data("modals-initialized")||(o.data("modals-initialized",1),o.on(a["bind.open"]+".modal","["+a["attribute.open"]+"]",function(t){var i=e(this),l=i.attr(a["attribute.open"]),c=o.find(l);a=n.extend({},a,r.parse(c,s.defaults,"data-modal-"));var u=s.getModal(c,a)||s.makeModal(c,a);!/^https?:\/\/|^\/|^\.\.\//.test(i.attr("href"))||t.ctrlKey||t.metaKey||t.preventDefault(),u.anchor=this,s.prevModal=c[0],u.open()}))},c.stop=function(t){var n=e(t);n.unbind(".modal"),n.data("modals-initialized",0),s.prevModal&&l(s.prevModal).close()},c.start("body"),c};"function"==typeof define&&define.amd?define(["jquery","js/lib/lucid","underscore","js/lib/data.attributes"],function(t,n,i,r){return e(t,n,i,r)}):"undefined"!=typeof window&&"undefined"==typeof ender&&(window.Modal=e(window.$,window.LucidJS,window._,window.DataAttributes))})();